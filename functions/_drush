#compdef drush
#autoload
#
local state ret=1

local -a _1st_arguments

local expl

declare -ga common_args
common_args=(${(f)"$(_call_program drush drush zsh-options --pipe)"})
common_args+=(
  '(-r --root=)'{-r,--root=}'[Drupal root directory to use (default: current directory)]:directory:_path_files -/'
)

typeset -A opt_args
_arguments \
  $common_args \
  ':subcommand:->subcommand' \
  '*::options:->options' && ret=0
  
case $state in
  subcommand)
    subcommands=(${(f)"$(_call_program drush drush zsh-commands --pipe)"})
    _describe -t subcommands 'drush subcommand' subcommands && ret=0
    ;;
  
  options)
    declare -a args
    declare -a local_args
    
    local_args=(${(f)"$(_call_program drush drush zsh-options --pipe $words[1])"})
    
    args=(
      $common_args
      $local_args
    )

    case $words[1] in
      features-update|fu|feature-revert|fr)
        local features
        features=(${(f)"$(_call_program drush drush zsh-features-list --pipe)"})
        
        args+=(
          '*:feature:('$features')'
        )
        ;;

# <<<<<<< HEAD
case $cmd in
  (cache-clear)
    local -a _cache_clear_arguments
    _cache_clear_arguments=(
      'all:Clear all caches'
      'theme:Clear theme registry'
      'menu:Rebuild menu'
      'css+js:Clear css and js'
    )
    _describe -t commands "clear cache subcommand" _cache_clear_arguments ;;
  (pm-enable|en|pm-disable|dis|pm-uninstall|pm-updatecode|upc|pm-update|up|pm-info)
    local -a _modules
    _modules=(${(f)"$(_call_program drush drush --pipe pm-list)"})
    _describe -t commands "module subcommand" _modules
    ;;
  (sql-dump)
    args=("--result-file=+[save to a file]:result directory:_files -/")
  ;;
  (pm-download)
    _drupal_remote_directories;;
# =======
#       pm-enable|en)
#         args+=(
#           ':module:__drush_modules'
#         )
#         ;;

#       pm-disable|dis)
#         local -a modules
#         modules=(${(f)"$(_call_program drush drush zsh-extensions-list --status=enabled --pipe)"})

#         args+=(
#           '*:module:('$modules')'
#         )
#         ;;

#       pm-uninstall)
#         local -a modules
#         modules=(${(f)"$(_call_program drush drush zsh-extensions-list --status=disabled --pipe)"})

#         args+=(
#           '*:module:('$modules')'
#         )
#         ;;
#     esac
    
#     _arguments $args && ret=0
#     ;;
# >>>>>>> Updates to drush autocomplete
esac

__drush_modules () {
  local expl
  declare -a modules

  modules=(${(f)"$(_call_program drush drush zsh-extensions-list --status=enabled --pipe)"})

  _wanted modules expl 'modules' compadd $* - $modules
}

return ret
